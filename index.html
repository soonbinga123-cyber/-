<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slot Machine - 확률 조정 + 당첨 카운트</title>
  <style>
    :root{
      --bg:#08121a;
      --card:#0b1720;
      --accent:#f5c542;
      --muted:#9aa7b2;
      --danger:#ffbcbc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:18px;
      font-family: "Apple SD Gothic Neo","Noto Sans KR", Arial, sans-serif;
      background:linear-gradient(180deg,#07121a 0%, #0f2230 100%);
      color:#fff;
      padding:28px;
    }
    .card{
      background:linear-gradient(180deg,var(--card), #071018);
      padding:18px;
      border-radius:12px;
      box-shadow:0 6px 28px rgba(0,0,0,0.6);
      width:860px;
      max-width:96%;
      border:1px solid rgba(255,255,255,0.03);
    }
    h1{margin:0 0 8px; font-size:20px}
    .top-row{display:flex; gap:18px; align-items:flex-start;}
    #slotCanvas{
      background:#001217;
      border-radius:8px;
      border:4px solid #000;
      width:600px;
      height:200px;
      display:block;
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:8px;
      flex-wrap:wrap;
    }
    button{
      background:var(--accent);
      color:#111;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
    }
    button:disabled{opacity:0.5; cursor:not-allowed}
    .info{color:var(--muted); font-size:13px}
    .sidebar{width:220px;}
    .prob-row{display:flex; gap:8px; align-items:center; margin-bottom:8px}
    .prob-row input[type="number"]{width:60px; padding:6px; border-radius:6px; border:1px solid #333; background:#07131a; color:#fff}
    .prob-row input[type="range"]{flex:1}
    .prob-label{width:36px; text-align:center}
    .stats{margin-top:12px; font-size:14px; color:var(--muted)}
    .small{font-size:12px; color:#9aa7b2; margin-top:6px}
    /* modal overlay */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:999}
    .overlay.active{display:flex}
    .modal{background:#fff; color:#111; width:520px; border-radius:10px; padding:18px; text-align:center}
    .danger{background:var(--danger); padding:10px; border-radius:8px; color:#8a1212; font-weight:700; margin:8px 0}
    input[type="password"]{padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; width:160px}
    .flex-col{display:flex; flex-direction:column; gap:8px}
    .footer{margin-top:12px; font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <h1>🎰 슬롯머신 — 확률 조정 & 당첨 카운트</h1>
    <div class="top-row">
      <div>
        <canvas id="slotCanvas" width="600" height="200"></canvas>

        <div class="controls">
          <button id="spinBtn">Spin</button>
          <button id="resetCountBtn" title="스핀 카운트 초기화">Reset Count</button>
          <div class="info" id="countInfo">연속 스핀: 0</div>
        </div>

        <div class="footer small">스페이스바로도 스핀할 수 있습니다.</div>
      </div>

      <div class="sidebar">
        <div style="font-weight:700; margin-bottom:8px">심볼 확률 조정</div>

        <div id="probList"></div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="normalizeBtn">정규화 (자동)</button>
          <button id="randomizeBtn">랜덤 초기화</button>
        </div>

        <div class="stats">
          <div>총 스핀: <span id="totalSpins">0</span></div>
          <div>잭팟(모두 동일) 횟수: <span id="jackpotCount">0</span></div>
          <div>현재 확률 합계: <span id="probSum">0</span></div>
        </div>

        <div class="small">각 심볼에 0 이상의 가중치 입력 (0 가능). 비율은 자동으로 계산되어 적용됩니다.</div>
      </div>
    </div>

    <div class="small" style="margin-top:12px;">
      연속으로 3번 스핀하면 게임이 잠기고 "도박은 위험하다"가 표시됩니다. 잠김 해제는 비밀번호 필요 (기본 비밀번호: <strong>0000</strong>).
    </div>
  </div>

  <!-- 잠금 모달 -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle">도박은 위험합니다</h2>
      <div class="danger">도박은 위험하다</div>
      <div>계속하려면 비밀번호를 입력하세요.</div>
      <div style="margin-top:10px;">
        <input id="pwInput" type="password" placeholder="비밀번호 입력" />
        <button id="unlockBtn">확인</button>
      </div>
      <div class="small" style="margin-top:8px;">기본 비밀번호는 코드 상단의 UNLOCK_PASSWORD 값입니다.</div>
    </div>
  </div>

  <script>
    /*****************************************
     * 슬롯머신: 확률(가중치) 조정 + 당첨 카운트
     *****************************************/
    const UNLOCK_PASSWORD = "0000"; // 필요시 변경

    // 심볼 & 초기 가중치
    const symbols = ["🍒","🔔","💎","🍋","7️⃣","⭐"];
    // 기본 가중치 (모두 동일)
    let weights = Array(symbols.length).fill(1);

    // 상태 변수
    let totalSpins = 0;
    let jackpotCount = 0;
    let consecutiveSpins = 0;
    let locked = false;

    // Canvas
    const canvas = document.getElementById("slotCanvas");
    const ctx = canvas.getContext("2d");
    const numSlots = 3;
    const slotWidth = canvas.width / numSlots;
    let slotPositions = [0,0,0];
    let spinning = [false,false,false];
    let spinStartTime = [0,0,0];
    let targetResult = [0,0,0];

    // UI 요소
    const spinBtn = document.getElementById("spinBtn");
    const resetCountBtn = document.getElementById("resetCountBtn");
    const countInfo = document.getElementById("countInfo");
    const probListDiv = document.getElementById("probList");
    const normalizeBtn = document.getElementById("normalizeBtn");
    const randomizeBtn = document.getElementById("randomizeBtn");
    const totalSpinsEl = document.getElementById("totalSpins");
    const jackpotCountEl = document.getElementById("jackpotCount");
    const probSumEl = document.getElementById("probSum");

    // modal
    const overlay = document.getElementById("overlay");
    const pwInput = document.getElementById("pwInput");
    const unlockBtn = document.getElementById("unlockBtn");

    // --- 그리기 ---
    function drawSlots(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#04121a";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = "80px serif";

      for(let i=0;i<numSlots;i++){
        const xCenter = i*slotWidth + slotWidth/2;
        const yCenter = canvas.height/2;
        let idx = ((Math.floor(slotPositions[i]) % symbols.length) + symbols.length) % symbols.length;
        ctx.fillStyle = "#fff";
        ctx.fillText(symbols[idx], xCenter, yCenter);
      }
    }

    // --- 애니메이션 ---
    function animate(){
      let anySpinning = false;
      for(let i=0;i<numSlots;i++){
        if(spinning[i]){
          anySpinning = true;
          const elapsed = Date.now() - spinStartTime[i];
          const duration = 1600 + i*450;
          if(elapsed < duration){
            slotPositions[i] += 0.4 + (1 - elapsed/duration) * 7;
          } else {
            spinning[i] = false;
            slotPositions[i] = targetResult[i];
          }
        }
      }

      drawSlots();

      if(anySpinning){
        requestAnimationFrame(animate);
      } else {
        // 멈춘 후 체크
        handleSpinEnd();
      }
    }

    function handleSpinEnd(){
      // 스핀 카운트 증가(총 스핀)
      totalSpins++;
      totalSpinsEl.textContent = totalSpins;

      // 당첨 체크 (모두 동일)
      if(targetResult[0] === targetResult[1] && targetResult[1] === targetResult[2]){
        jackpotCount++;
        jackpotCountEl.textContent = jackpotCount;
        setTimeout(()=> alert("🎉 Jackpot!"), 60);
      }
    }

    // --- 확률(가중치)에 따른 랜덤 선택 ---
    function weightedRandomIndex(){
      const sum = weights.reduce((a,b)=> a + b, 0);
      if(sum <= 0){
        // 모든 가중치가 0이면 균등 선택
        return Math.floor(Math.random() * weights.length);
      }
      const r = Math.random() * sum;
      let acc = 0;
      for(let i=0;i<weights.length;i++){
        acc += weights[i];
        if(r < acc) return i;
      }
      // 안전장치
      return weights.length - 1;
    }

    function getRandomResult(){
      // 각 릴 독립적으로 가중치에 따라 선택
      return [
        weightedRandomIndex(),
        weightedRandomIndex(),
        weightedRandomIndex()
      ];
    }

    // --- 스핀 시작 ---
    function startSpinFromUser(){
      if(locked) return;

      targetResult = getRandomResult();
      for(let i=0;i<numSlots;i++){
        spinning[i] = true;
        spinStartTime[i] = Date.now() + i*50;
      }
      animate();

      consecutiveSpins++;
      updateCountInfo();
      if(consecutiveSpins >= 3){
        lockGame();
      }
    }

    function updateCountInfo(){
      countInfo.textContent = `연속 스핀: ${consecutiveSpins}`;
    }

    function lockGame(){
      locked = true;
      spinBtn.disabled = true;
      showLockModal();
    }

    function unlockGame(){
      locked = false;
      consecutiveSpins = 0;
      updateCountInfo();
      spinBtn.disabled = false;
      hideLockModal();
      pwInput.value = "";
    }

    // --- UI: 확률 컨트롤 생성 ---
    function renderProbControls(){
      probListDiv.innerHTML = "";
      for(let i=0;i<symbols.length;i++){
        const row = document.createElement("div");
        row.className = "prob-row";

        const label = document.createElement("div");
        label.className = "prob-label";
        label.textContent = symbols[i];

        const range = document.createElement("input");
        range.type = "range";
        range.min = 0;
        range.max = 100;
        range.step = 1;
        range.value = weights[i] * 10; // 내부적으로 표시용
        range.dataset.index = i;

        const num = document.createElement("input");
        num.type = "number";
        num.min = 0;
        num.step = 1;
        num.value = weights[i];

        const pct = document.createElement("div");
        pct.style.width = "56px";
        pct.style.textAlign = "right";
        pct.style.fontSize = "13px";
        pct.style.color = "var(--muted)";

        // 동기화
        function syncFromRange(){
          const idx = Number(range.dataset.index);
          const val = Math.max(0, Number(range.value));
          // range는 0..100 -> 가중치로 변환 (여기선 0..10)
          const w = Math.round(val / 10);
          weights[idx] = w;
          num.value = w;
          updateProbDisplay();
        }
        function syncFromNum(){
          const idx = Number(range.dataset.index);
          let val = Number(num.value);
          if(isNaN(val) || val < 0) val = 0;
          weights[idx] = Math.round(val);
          range.value = weights[idx] * 10;
          updateProbDisplay();
        }

        range.addEventListener("input", syncFromRange);
        num.addEventListener("change", syncFromNum);

        row.appendChild(label);
        row.appendChild(range);
        row.appendChild(num);
        row.appendChild(pct);

        probListDiv.appendChild(row);
      }

      updateProbDisplay();
    }

    function updateProbDisplay(){
      const sum = weights.reduce((a,b)=> a + b, 0);
      probSumEl.textContent = sum.toFixed(0);

      // update each pct text (iterate children)
      const rows = probListDiv.querySelectorAll(".prob-row");
      rows.forEach((row, idx) => {
        const pctDiv = row.querySelector("div:last-child");
        let p = 0;
        if(sum > 0) p = (weights[idx] / sum) * 100;
        pctDiv.textContent = p.toFixed(1) + "%";
      });
    }

    // 정규화(자동): 가중치들을 합이 100이 되게 재스케일 - 여기서는 내부 정수 가중치로 유지
    function normalizeWeights(){
      const sum = weights.reduce((a,b)=> a + b, 0);
      if(sum <= 0){
        // 전부 0이면 균등 가중치 1로 변경
        weights = Array(weights.length).fill(1);
      } else {
        // 비율 유지하되 최소 1로 보정하여 정수화
        // 목표: 가중치들을 소수로 유지하는 대신 간단히 비율을 보정
        const normalized = weights.map(w => w / sum);
        // 스케일하여 정수로 만들기 (총합 100 -> 가시적으로 보기 좋음)
        const scaled = normalized.map(v => Math.max(0, Math.round(v * 100)));
        // 보정: 합이 0 또는 !=100 이면 마지막 심볼에 나머지 추가
        let s = scaled.reduce((a,b)=>a+b,0);
        if(s === 0){
          for(let i=0;i<scaled.length;i++) scaled[i] = 1;
          s = scaled.reduce((a,b)=>a+b,0);
        }
        if(s !== 100){
          scaled[scaled.length - 1] += (100 - s);
        }
        // 내부 가중치는 scaled/10 (가독성), 최소 0
        weights = scaled.map(v => Math.max(0, Math.round(v/10)));
        // 보정: 만약 모두 0이면 1로
        if(weights.every(w => w === 0)){
          weights = Array(weights.length).fill(1);
        }
      }
      renderProbControls();
    }

    function randomizeWeights(){
      for(let i=0;i<weights.length;i++){
        weights[i] = Math.floor(Math.random() * 6); // 0..5
      }
      // 보정: 모두 0이면 1
      if(weights.every(w => w === 0)) weights[0] = 1;
      renderProbControls();
    }

    // --- 이벤트 바인딩 ---
    spinBtn.addEventListener("click", () => {
      startSpinFromUser();
    });
    resetCountBtn.addEventListener("click", () => {
      consecutiveSpins = 0;
      locked = false;
      spinBtn.disabled = false;
      updateCountInfo();
      hideLockModal();
    });

    normalizeBtn.addEventListener("click", normalizeWeights);
    randomizeBtn.addEventListener("click", randomizeWeights);

    // modal actions
    function showLockModal(){
      overlay.classList.add("active");
      setTimeout(()=> pwInput.focus(), 200);
    }
    function hideLockModal(){
      overlay.classList.remove("active");
    }

    unlockBtn.addEventListener("click", ()=>{
      const v = pwInput.value;
      if(v === UNLOCK_PASSWORD){
        unlockGame();
      } else {
        pwInput.style.animation = "shake 300ms";
        setTimeout(()=> pwInput.style.animation = "", 300);
      }
    });
    pwInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") unlockBtn.click();
    });

    // 스페이스로 스핀
    window.addEventListener("keydown", (e)=>{
      if(e.code === "Space"){
        e.preventDefault();
        spinBtn.click();
      }
    });

    // CSS 애니메이션(흔들림)
    const styleEl = document.createElement("style");
    styleEl.textContent = `
      @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        50% { transform: translateX(6px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
      }
    `;
    document.head.appendChild(styleEl);

    // 초기 렌더링
    function init(){
      renderProbControls();
      drawSlots();
      updateCountInfo();
      totalSpinsEl.textContent = totalSpins;
      jackpotCountEl.textContent = jackpotCount;
      updateProbDisplay();
    }

    init();

    // Expose some functions for debugging in console (선택)
    window._slot = {
      weights, getRandomResult, startSpinFromUser, normalizeWeights, randomizeWeights
    };

  </script>
</body>
</html>
